<canvas id="canvas" width="640" height="480"></canvas>

<audio id="sound1" preload="auto">
  <source src="sounds/sound1.mp3" />
</audio>
<audio id="sound2" preload="auto">
  <source src="sounds/sound2.mp3" />
</audio>
<audio id="sound3" preload="auto">
  <source src="sounds/sound3.mp3" />
</audio>


<script>
function play(audio_id) {
  document.getElementById(audio_id).currentTime = 0;
  document.getElementById(audio_id).play();
}

function set_sound(audio_id) {
  drop1_sound = audio_id;
}

var sound_on = true;
function onoff() {
  sound_on = !sound_on;
}

// Tempo class
Tempo = function(step, offset) {
  this.offset = offset;
  this.step = step;
}

Tempo.prototype.is_active = function(count) {
  //console.log(count + ", " + this.offset + ", " + this.step);
  return (count + this.offset) % this.step == 0;
}

// Returns lists of incoming tempo in ascending order in [0, 100)
// 99 is the max. e.g. [0, 25, 50, 75]
Tempo.prototype.get_sequence = function(count) {
  var mod = (count + this.offset) % this.step;
  var offset = (mod == 0) ? 0 : this.step - mod;

  var sequence = [];
  for (var val = offset; val < 100; val += this.step) {
    sequence.push(val);
  }
  return sequence;
}

// Bucket class
Bucket = function(sound, color, image_src) {
  this.sound = sound;
  this.color = color;
  this.image = new Image();
  this.image.src = image_src;
}

var BUCKET_LIST = [
  new Bucket("sound3", "#F44336",  // Red
             "images/dish_cup.png"),
  new Bucket("sound1", "#3F51B5",  // Blue
             "images/pot.png"),
  new Bucket("sound2", "#009688",  // Green
             "images/dish_owan.png"),
]

var INTERVAL_MS = 100;
var GRAVITY = 9.8;  // meter / sec^2
var FIELD_HEIGHT = 20;  // meter

function fallen_height(time_ms) {
  return Math.min(
    FIELD_HEIGHT,
    0.5 * GRAVITY * time_ms / 1000 * time_ms / 1000
  );
}

// Returns a random number from 1 to max_val.
function random_tempo(max_val, step) {
  var val = Math.round(Math.random() * max_val);
  return val - (val % step) + step;
}

var TOUCH_TIME_MS = 0;
for (TOUCH_TIME_MS = 0;
  fallen_height(TOUCH_TIME_MS) < FIELD_HEIGHT;
  TOUCH_TIME_MS += INTERVAL_MS);


var count = 0;
var droid0 = new Tempo(20, 0);
var droid1 = new Tempo(20, 10);

var drop1 = new Tempo(random_tempo(15, 5), 0);
var drop2 = new Tempo(random_tempo(20, 5), 5);
var drop3 = new Tempo(random_tempo(30, 10), 10);

var drop1_bucket = 0;
var drop2_bucket = 1;
var drop3_bucket = 2;

var droid_image0 = new Image();
droid_image0.src = "images/droid0.png";
var droid_image1 = new Image();
droid_image1.src = "images/droid1.png";
var droid_image = droid_image0;

function loop() {
  if (!sound_on) { return; }

  if (droid0.is_active(count)) {
    droid_image = droid_image0;
    // droid_image.src = "images/droid0.png";
  }
  if (droid1.is_active(count)) {
    droid_image = droid_image1;
    // droid_image.src = "images/droid1.png";
  }

  draw(count);

  if (drop3.is_active(count)) { play(BUCKET_LIST[drop3_bucket].sound); }
  if (drop2.is_active(count)) { play(BUCKET_LIST[drop2_bucket].sound); }
  if (drop1.is_active(count)) { play(BUCKET_LIST[drop1_bucket].sound); }

  count += 1;
}

var drop_image = new Image();
drop_image.src = "images/water_shizuku.png";

function draw_drop(context, count, tempo, x, height) {
  var sequence = tempo.get_sequence(count);
  for (var i = 0; i < sequence.length; ++i) {
    // By adding INTERVAL_MS to TOUCH_TIME_MS, time_ms can be fully ranged
    // from 0 to TOUCH_TIME_MS.
    if (INTERVAL_MS * sequence[i] > TOUCH_TIME_MS + INTERVAL_MS) {
      break;
    }

    var time_ms = Math.max(0, TOUCH_TIME_MS - INTERVAL_MS * sequence[i]);
    var y = height * fallen_height(time_ms) / FIELD_HEIGHT;

    context.drawImage(drop_image, x - 18, y - 24, 36, 36);
  }
}

function draw_bucket(context, x, y, bucket) {
  context.drawImage(bucket.image, x - 30, y - 60, 60, 60);
}

var background_img = new Image();
background_img.src = "images/background.png";

function draw(count) {
  var canvas = document.getElementById("canvas");
  var context = canvas.getContext('2d');
  context.drawImage(background_img, 0, 0, canvas.width, canvas.height);
  context.drawImage(droid_image,
                    canvas.width - 48, canvas.height - 48,
                    48, 48);
  //context.clearRect(0, 0, canvas.width, canvas.height);

  var ground_height = canvas.height * 0.9;
  draw_drop(context, count, drop1, 160, ground_height);
  draw_drop(context, count, drop2, 320, ground_height);
  draw_drop(context, count, drop3, 480, ground_height);

  draw_bucket(context, 160, ground_height + 20, BUCKET_LIST[drop1_bucket]);
  draw_bucket(context, 320, ground_height + 20, BUCKET_LIST[drop2_bucket]);
  draw_bucket(context, 480, ground_height + 20, BUCKET_LIST[drop3_bucket]);

//  context.drawImage(droid_image,
                    //canvas.width - 24, canvas.height - 24,
                    //24, 24);
}

function isIn(clientX, clientY, x, y, width, height) {
  return (x <= clientX && clientX <= x + width &&
          y <= clientY && clientY <= y + height);
}

function onTouchEvent(event) {
  var clientRect = event.target.getBoundingClientRect();
  var touchX = event.clientX - clientRect.left;
  var touchY = event.clientY - clientRect.top;

  var bucket_y = clientRect.height * 0.9 + 20;

  if (isIn(touchX, touchY, 120, bucket_y - 40, 80, 80)) {
    drop1_bucket = (drop1_bucket + 1) % BUCKET_LIST.length;
  }
  if (isIn(touchX, touchY, 280, bucket_y - 40, 80, 80)) {
    drop2_bucket = (drop2_bucket + 1) % BUCKET_LIST.length;
  }
  if (isIn(touchX, touchY, 440, bucket_y - 40, 80, 80)) {
    drop3_bucket = (drop3_bucket + 1) % BUCKET_LIST.length;
  }

  if (isIn(touchX, touchY,
           clientRect.right - 48, clientRect.bottom - 48, 48, 48)) {
    onoff();
  }
}

document.getElementById("canvas").addEventListener("click", onTouchEvent);

setInterval(function() { loop(); }, INTERVAL_MS);

</script>
