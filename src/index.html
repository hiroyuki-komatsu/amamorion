<button onClick="play('sound1')">1</button>
<br/>
<button onClick="play('sound2')">2</button>
<br/>
<button onClick="play('sound3')">3</button>
<br/>
<button onClick="onoff()">on / off</button>

<audio id="sound1" preload="auto">
  <source src="sounds/sound1.mp3" />
</audio>
<audio id="sound2" preload="auto">
  <source src="sounds/sound2.mp3" />
</audio>
<audio id="sound3" preload="auto">
  <source src="sounds/sound3.mp3" />
</audio>

<canvas id="canvas" width="640" height="320"></canvas>

<img id="tempo" src="images/droid0.png">

<script>
function play(audio_id) {
  document.getElementById(audio_id).currentTime = 0;
  document.getElementById(audio_id).play();
}

var sound_on = true;
function onoff() {
  sound_on = !sound_on;
}

// Tempo class
Tempo = function(step, offset) {
  this.offset = offset;
  this.step = step;
}

Tempo.prototype.is_active = function(count) {
  //console.log(count + ", " + this.offset + ", " + this.step);
  return (count + this.offset) % this.step == 0;
}

// Returns lists of incoming tempo in ascending order in [0, 100)
// 99 is the max. e.g. [0, 25, 50, 75]
Tempo.prototype.get_sequence = function(count) {
  var mod = (count + this.offset) % this.step;
  var offset = (mod == 0) ? 0 : this.step - mod;

  var sequence = [];
  for (var val = offset; val < 100; val += this.step) {
    sequence.push(val);
  }
  return sequence;
}

var INTERVAL_MS = 100;
var GRAVITY = 9.8;  // meter / sec^2
var FIELD_HEIGHT = 20;  // meter

function fallen_height(time_ms) {
  return Math.min(
    FIELD_HEIGHT,
    0.5 * GRAVITY * time_ms / 1000 * time_ms / 1000
  );
}

var TOUCH_TIME_MS = 0;
for (TOUCH_TIME_MS = 0;
  fallen_height(TOUCH_TIME_MS) < FIELD_HEIGHT;
  TOUCH_TIME_MS += INTERVAL_MS);


var count = 0;
var droid0 = new Tempo(20, 0);
var droid1 = new Tempo(20, 10);

var sound1 = new Tempo(10, 0);
var sound2 = new Tempo(10, 5);
var sound3 = new Tempo(100, 0);

function loop() {
  if (!sound_on) { return; }

  if (droid0.is_active(count)) {
    var tempo = document.getElementById("tempo");
    tempo.src = "images/droid0.png";
  }
  if (droid1.is_active(count)) {
    var tempo = document.getElementById("tempo");
    tempo.src = "images/droid1.png";
  }

  if (sound3.is_active(count)) { play('sound3'); }
  else if (sound2.is_active(count)) { play('sound2'); }
  else if (sound1.is_active(count)) { play('sound1'); }

  draw(count);
  count += 1;
}

function draw_drop(context, count, tempo, x, height) {
  var sequence = tempo.get_sequence(count);
  for (var i = 0; i < sequence.length; ++i) {
    if (INTERVAL_MS * sequence[i] > TOUCH_TIME_MS + INTERVAL_MS) {
      break;
    }

    var time_ms = Math.max(0, TOUCH_TIME_MS - INTERVAL_MS * sequence[i]);
    var y = height * fallen_height(time_ms) / FIELD_HEIGHT;

    context.beginPath();
    context.arc(x, y, 10, Math.PI*2, false);
    context.stroke();
  }
}

function draw(count) {
  var step = count % 10 + 1;
  var canvas = document.getElementById("canvas");
  var context = canvas.getContext('2d');
  context.clearRect(0, 0, canvas.width, canvas.height);

  draw_drop(context, count, sound1, 160, 320);
  draw_drop(context, count, sound2, 320, 320);
  draw_drop(context, count, sound3, 480, 320);
}

setInterval(function() { loop(); }, INTERVAL_MS);

</script>
